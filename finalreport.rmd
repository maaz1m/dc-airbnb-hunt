---
title: "D.C. Airbnb Hunt"
author: "Foo Fivers: Adrienne Rogers ; Atharva Haldankar ; Mohammad Maaz ; Ricky Li"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    toc: true
    number_sections: true

---

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
library(dplyr)
library(knitr)
library(kableExtra)
library(readr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(leaflet)
library(tidytext)
library(stringr)
knitr::opts_chunk$set(warning = FALSE, fig.align = 'center')
```

# Introduction

For the final project, Team Five owns a few properties in DC that we would like to list on AirBnB. Before creating the listing, we need to know what is the most competitive price to list each of our properties at.

# SMART Question

The question we hope to answer with this project is "Given certain attributes of a rental property, what is a competitive price to list it on AirBnB?"

# Dataset

```{r, echo = FALSE}
df <- read.csv('listings_detailed.csv')
```

The raw data is obtained from Inside Airbnb, an open-source data tool providing the web scraped Airbnb listing information by cities. It includes `r nrow(df)` records with `r ncol(df)` data columns in total size. Below are all of the data columns. For example, we have columns for id, price, host name, location, neighborhood, review ratingscore, etc.
  
```{r}
glimpse(df)
```

```{r}

# get columns we need
df <- df %>% 
  select(id, name, neighbourhood_cleansed, latitude, longitude, accommodates, room_type, bedrooms, beds, amenities, price) %>% 
  mutate(price = as.numeric(parse_number(price)),
         neighbourhood_cleansed = as.factor(neighbourhood_cleansed),
         room_type = as.factor(room_type),
         bedrooms = as.factor(bedrooms)) %>%
  rename(neighbourhood = neighbourhood_cleansed)

# remove all NAs
df = na.omit(df)
```
  
We then preprocessed this raw dataset by selecting specific data columns and converting the datatypes of some columns. Eventually, the cleaned dataset has `r ncol(df)` records with `r nrow(df)` columns after column renaming and NA removal.

```{r, echo = FALSE}
#pretty output for presentation
data.frame(variable = names(df),
           classe = sapply(df, typeof),
           first_values = sapply(df, function(x) paste0(head(x,2),  collapse = ", ")),
           row.names = NULL) %>% 
  kable()
```

The amenities column was not usable as is, so we parse it to create indicator variables for each amenity.
```{r}
# remove commas and stuff from amenities
df$amenities <- str_replace_all(df$amenities, "[\"\\[\\]]", "")

# get all possible amenities
all_amenities = as.data.frame(table(strsplit(paste(df$amenities, collapse=' '),", "))) %>% rename(amenity=Var1)

# get most frequent amenities
top_amenities = all_amenities %>% filter(Freq > 300)

# create an indicator column for each amenity
for (a in top_amenities$amenity){
  colname <- tolower(str_replace_all(a, " ", "_"))
  df[colname] <- as.factor(grepl(a, df$amenities))
}

df %>% select(bed_linens:breakfast) %>% head()  %>% kable()
```


# Exploratory Data Analysis

# Modeling

## Linear Regression

## Regression Tree

## K-nearest Neighbours

## PCA

## Comparison

# Example predictions

# Future work

# Conclusion and Discussion


# References


```{r results='markup'}
# encode the variables

library(mltools)
library(data.table)
library(randomForest)
library(Metrics)
df.prep = as.data.table(df)
df_encoded = one_hot(df.prep)
```



```{r results = 'markup'}
# drop unnecessary columns that cant be proceeded not encoded correctly
df_pcr = subset(df_encoded, select = -c(id, name, amenities))
#df_pcr[,165]
#df_pcr[,80]
df_pcr = df_pcr[,-c(80,165)]
```



```{r results = 'markup'}
#split train test
data = sort(sample(nrow(df_pcr), nrow(df_pcr)*0.7))
train_data = df_pcr[data,]
test_data = df_pcr[-data,]
```

```{r}
#encode
names(df_pcr) <- gsub(" ", "_", names(df_pcr))
names(df_pcr) <- gsub(",", "", names(df_pcr))
names(df_pcr) <- gsub("-", ".", names(df_pcr))
names(df_pcr) <- gsub("/", ".", names(df_pcr))


names(train_data) <- gsub(" ", "_", names(train_data))
names(train_data) <- gsub(",", "", names(train_data))

names(test_data) <- gsub(" ", "_", names(test_data))
names(test_data) <- gsub(",", "", names(test_data))

names(train_data) <- gsub("-", ".", names(train_data))
names(test_data) <- gsub("-", ".", names(test_data))

names(train_data) <- gsub("/", ".", names(train_data))
names(test_data) <- gsub("/", ".", names(test_data))
```



```{r results = 'markup'}
rf.model2 = randomForest(price ~ ., data=train_data, type = 'regression', ntree = 2000, mtry = 10, importance = TRUE, na.action = na.omit)
```

```{r results = 'markup'}
print(rf.model2)
```

```{r results = 'markup'}
plot(rf.model2)
```



```{r}
#install.packages('Metrics')
pred_total = predict(rf.model2, df_pcr)

res_total = df_pcr$price - pred_total

rm = rmse(df_pcr$price , pred_total)

rsq = 1 - var(res_total) / var(df_pcr$price)

ma = mae(df_pcr$price , pred_total)
```
The MSE of Random Forest is ```r rm```, R-Sqaured is ```r rsq```, MAE is ```r ma```
